#!/bin/bash

# Simple terminal system monitor for Linux
# Usage: sysmon [live|top|setup|help] [count]

mode="${1:-live}"
count="${2:-5}"

# Help function
show_help() {
    cat << EOF
sysmon - Simple Terminal System Monitor

USAGE:
    sysmon [COMMAND] [ARGS]

COMMANDS:
    live              Live monitoring mode (default)
    top [count]       Show top processes (default: 5)
    setup             System information
    help              Show this message

EXAMPLES:
    sysmon                # Live CPU, RAM, GPU monitoring
    sysmon top 10         # Show top 10 processes
    sysmon setup          # Display system configuration
EOF
    exit 0
}

# Validate input
if [[ "$mode" == "help" ]] || [[ "$mode" == "-h" ]] || [[ "$mode" == "--help" ]]; then
    show_help
fi

# Validate count is a number
if ! [[ "$count" =~ ^[0-9]+$ ]]; then
    echo "Error: count must be a number" >&2
    exit 1
fi

if [ "$mode" = "setup" ]; then
    clear
    echo "╔════════════════════════════════════════╗"
    echo "║     SYSTEM SETUP INFORMATION           ║"
    echo "╚════════════════════════════════════════╝"
    echo

    # CPU info
    printf "%-20s" "CPU:"
    lscpu | grep "Model name" | sed 's/Model name:[[:space:]]*//'
    printf "%-20s" "Core Count:"
    lscpu | grep "^CPU(s):" | awk '{print $2}'
    printf "%-20s" "Thread(s) per Core:"
    lscpu | grep "Thread(s) per core" | awk '{print $4}'
    echo

    # RAM info
    printf "%-20s" "RAM:"
    free -h | grep Mem | awk '{print $2}'
    echo

    # GPU info
    printf "%-20s" "GPU:"
    if command -v nvidia-smi &> /dev/null 2>&1; then
        nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null || echo "NVIDIA GPU detected but info unavailable"
    else
        gpu=$(lspci 2>/dev/null | grep -i 'vga\|3d\|2d' | head -n1)
        if [ -n "$gpu" ]; then
            echo "$gpu" | sed 's/.*: //'
        else
            echo "No GPU detected"
        fi
    fi
    echo
    exit 0
fi

if [ "$mode" = "top" ]; then
    while true; do
        clear
        printf "╔════════════════════════════════════════════════╗\n"
        printf "║  Top %d Processes by CPU Usage         ║\n" "$count"
        printf "╚════════════════════════════════════════════════╝\n"
        ps -eo pid,comm,%cpu,%mem --sort=-%cpu | head -n $((count + 1)) | awk 'NR==1 {printf "%-8s %-25s %8s %8s\n", $1, $2, $3, $4; next} {printf "%-8s %-25s %8s %8s\n", $1, substr($2, 1, 25), $3, $4}'
        
        echo
        printf "╔════════════════════════════════════════════════╗\n"
        printf "║  Top %d Processes by RAM Usage         ║\n" "$count"
        printf "╚════════════════════════════════════════════════╝\n"
        ps -eo pid,comm,%cpu,%mem --sort=-%mem | head -n $((count + 1)) | awk 'NR==1 {printf "%-8s %-25s %8s %8s\n", $1, $2, $3, $4; next} {printf "%-8s %-25s %8s %8s\n", $1, substr($2, 1, 25), $3, $4}'

        sleep 2
    done
elif [ "$mode" = "live" ]; then
    while true; do
        # CPU usage
        cpu=$(top -bn1 2>/dev/null | grep "Cpu(s)" | awk '{print 100 - $8"%"}')
        cpu=${cpu:-"N/A"}

        # RAM usage
        ram=$(free 2>/dev/null | awk '/Mem:/ {printf("%.1f%%"), $3/$2 * 100.0}')
        ram=${ram:-"N/A"}

        # GPU usage (NVIDIA only)
        gpu="N/A"
        if command -v nvidia-smi &> /dev/null; then
            gpu=$(nvidia-smi --query-gpu=utilization.gpu --format=csv,noheader,nounits 2>/dev/null | head -n1)
            gpu="${gpu:-N/A}%"
        fi

        printf "\r%-40s" "CPU: $cpu | RAM: $ram | GPU: $gpu"
        sleep 1
    done
else
    echo "Error: Unknown command '$mode'" >&2
    echo "Run 'sysmon help' for usage information" >&2
    exit 1
fi
